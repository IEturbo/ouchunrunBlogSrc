---
title: WebRTC 权威指南摘录
date: 2019-3-30
tags: [webrtc, WebRTC 权威指南] 
---

### **1、webrtc信令及作用**
>信令是协调通信的过程。信令允许网络中的“智能”节点交换下列有关信息：呼叫的建立、监控、拆除以及网络管理等信息。

**信令的作用主要是以下四个方面：**

-	协商媒体功能和设置
-	标识和验证会话参与者的身份（交换SDP对象中的信息：媒体类型、编解码器、带宽等元数据）
-	控制媒体会话、指示进度、更改会话、终止会话
-	双占用分解

<!--more-->

---
#### **1.1媒体协商**
---

_信令最重要的功能在于，在参与对等链接的两个浏览器之间交换SDP(会话描述协议)对象中包含的信息_。此外，信令通道还用于交换候选地址，以便进行ICE打洞。最后还必须在信令通道中交换用于SRTP的秘钥材料。


SDP包含供浏览器中的RTP(实时传输协议)媒体栈配置媒体会话所需要的全部信息，包括：

-	媒体类型（音频、视频、数据）、
-	所用的编解码器（Opus、G.711）、
-	用于编解码器的各个参数或设置、
-	以及有关带宽的信息。


**候选地址：表示浏览器可从中接收潜在媒体数据包的IP地址和UDP端口。**

---

#### **1.2标识和身份验证**
---

在使用标准信令协议（例如SIP）发起实时通信时，信令通道需要提供参与者的标识，并可以选择进行身份验证。Webrtc中，除信令外，还有两种渠道可用于确定身份：

-	第一是参见Web应用程序提供的上下文。例如使用特定的屏幕名称进行登录。
-	第二是查看URL中可能传递的标识，此URL可能包含随机令牌。（这种方式建立webrtc会话，双方都应该知道该标识令牌）

WebRTC定义了另一种标识方法，即通过媒体通道。呼叫方的标识与身份验证由媒体路径提供，完全不依赖与信令通道。信令通道只是用于传输指纹和标识断言，但不以任何其他形式参与标识断言的生成或验证。

---
#### **1.3信令交互和RTCPeerConnection的建立**
---

WebRTC使用RTCPeerConnection建立连接传送流数据，在建立RTCPeerConnection实例之后，想要建立点对点的信道，需要做两件事：

-	确定本机上的媒体流的特性，比如分辨率、编解码能力等	（SDP描述符）
-	连接两端的主机的网络地址（ICE Candidate）


**通过offer和answer交换SDP描述符：**

	甲和乙各自建立一个PC实例
	
	甲通过PC所提供的createOffer()方法建立一个包含甲的SDP描述符的offer信令
	
	甲通过PC所提供的setLocalDescription()方法，将甲的SDP描述符交给甲的PC实例
	
	甲将offer信令通过服务器发送给乙
	
	乙将甲的offer信令中所包含的的SDP描述符提取出来，通过PC所提供的setRemoteDescription()方法交给乙的PC实例
	
	乙通过PC所提供的createAnswer()方法建立一个包含乙的SDP描述符answer信令
	
	乙通过PC所提供的setLocalDescription()方法，将乙的SDP描述符交给乙的PC实例
	
	乙将answer信令通过服务器发送给甲
	
	甲接收到乙的answer信令后，将其中乙的SDP描述符提取出来，调用setRemoteDescripttion()方法交给甲自己的PC实例

---
### **2、WebRTC信令的传输方式**
---
#### **2.1三种传输方式(web)**
---

WebRTC要求在浏览器间建立双向信令通道，通常有三种方式用于传输WebRTC信令：**HTTP、WebSocket和数据通道。**

-	**HTTP:通信只能有客户端发起，HTTP做不到服务器主动向客户端推送消息。**也就是我们只能通过客户端向服务器发出请求，服务器返回查询结果。
（只要服务器支持CORS(跨域资源共享)，服务器的IP地址就可以不同于Web服务器。）
-	**长轮询**：也可以采用异步AJAX，通过单纯轮询或让GET请求持续开放来准备接受来自服务器的数据。但是轮询的效率比较低，而且很浪费资源，因为必须不停链接或者HTTP链接始终打开。
-	**WebSocket:允许浏览器开通一个与服务器的双向连接**， websocket最大特点就是，服务器可以主动向客户端推送信息，客户端也可以主动向服务器发送信息，是真正的双向平等对话，属于服务器推送技术的一种。
（只要信令服务器支持CORS(跨域资源共享)，WebSocket服务器的IP地址就可以不同于Web服务器。）
-	**数据通道传输**

---
#### **2.2 Websocket与HTTP传输方式**
---

http消息传输方式如下：

![1.png](https://i.loli.net/2019/03/30/5c9f183e10a95.png)
 
    

websocket代理信令传输：
 
![2.png](https://i.loli.net/2019/03/30/5c9f183e12b36.png)

---
#### **2.3 WebSocket其他特点**
---

-	建立在 TCP 协议之上，服务器端的实现比较容易。
-	与 HTTP 协议有着良好的兼容性。默认端口也是80和443，并且握手阶段采用 HTTP 协议，因此握手时不容易屏蔽，能通过各种 HTTP 代理服务器。
-	数据格式比较轻量，性能开销小，通信高效。
-	可以发送文本，也可以发送二进制数据。
-	没有同源限制，客户端可以与任意服务器通信。
-	协议标识符是ws（如果加密，则为wss），服务器网址就是 URL。

---
### **3、对等媒体**
---

#### **3.1 WebRTC和网络地址转换**
---

**网络地址转换方式有：**

-	通过多个NAT的对等媒体流
-	通过通用NAT的对等媒体流
-	私有地址和公共地址

浏览器位于网络地址转换设备（NAT）之后是一种极为普遍的设计：位于NET之后的WebRTC浏览器例子：

![3.png](https://i.loli.net/2019/03/30/5c9f183e2382f.png)
 

 公共与私有IP地址与NAT：
 
![4.png](https://i.loli.net/2019/03/30/5c9f183e28d37.png)
 
 
**NAT实际上是网络地址和端口转换器(Network Adderss and Port Translator, NAPT)**

---
#### **3.2 STUN服务器**
---

STUN，Session Traversal Utilities for NAT，称为NAT会话遍历实用工具服务器。**简单地说，就是获取内网设备的最外层NAT（公共ip地址）信息。**

浏览器通过发送STUN数据包来检查STUN服务器，STUN服务器做出响应，指示其在测试数据包中检测到的IP地址。**也就是说，它使用NAT映射出的地址来做出响应。**对于从STUN服务器获取的这一IP地址，将于另一端的浏览器多共享，**此地址将成为潜在的“候选”地址。**
 
使用Stun服务器的浏览器：
![5.png](https://i.loli.net/2019/03/30/5c9f183e880ee.png)


---
#### **3.3 TURN服务器**
---

中继型NAT遍历服务器。浏览器通过查询TURN服务器来获取媒体中继地址。媒体中继地址是一个公共IP地址，用于转发从浏览器收到的数据包，或者将收到的数据包发送给浏览器。
 
由TURN服务器提供中继的媒体：
![6.png](https://i.loli.net/2019/03/30/5c9f183e85fc5.png)



说明：
   

>  媒体中继地址是一个公共地址，用于转发接收到的包，或者将收到的数据包转发给浏览器。如果两个对等端因为NAT类型等原因不能直接建立P2P连接的话，那么可以使用中继地址。
>     ps：相比较直接使用web服务器提供媒体中继理想点。


---
#### **3.4 候选项**
---

打洞技术依靠将要建立的会话中的每个对等端来收集一组和通过internet访问他们的潜在方式。这些IP地址和端口组称为“地址候选项”，简称“候选项”。

**在javascript中，这些候选项包含在RTCIceCandidatea对象的candidate属性中，也就是我们说的“候选人”。**

用于实现打洞技术的协议称为交互式连接建立（Interactive Connectivity Establishment,ICE）协议。

---
### **4、媒体捕获**
---
#### **4.1 WebRTC中的媒体**
---

**轨道**

**MediaStreamTrack是WebRTC中的基本媒体单元。** WebRTC不能直接访问或控制源(但是可以通过约束来选择并控制其属性)。对源的一切控制都通过轨道实施。
轨道不仅可以是来自源的原始媒体，还可能是浏览器提供的经过转换的版本。
暂停轨道的媒体的两种方式：静音和禁用。


**流**
**MediaStream是MedaiStreamTrack对象的集合。**

创建MedaiStreamd对象的两种方法：

-	通过现有MediaStram中复制轨道来请求本地媒体的访问（即使用getUserMeda）。
-	使用对等连接来接收新的流。

---
#### **4.2 捕获本地媒体**
---

- getUserMedai()，专门用于请求对本地媒体的访问。
- CreateObjectURL来基于MedaiStream创建URL.

---
### **5、对等链接和提议/应答协商**
---

> WebRTC标准定义了两组主要的功能：**一是媒体捕获；二是媒体传输。**对等连接和提议/应答协商的概念是建立WebRTC对等媒体和数据的核心。

---
#### **5.1、对等连接**
---
RTCPeerConnection接口是WebRTC的主要API，用来在P2P端建立媒体连接及数据连接路径。RTCPeerConnection对象的构造函数有一系列属性，最主要的是iceServers属性，表示服务器地址列表。用于帮助透过NAT和防火墙建立会话。

iceServers示例：

    var pc = new RTCPeerConnection({
        iceServers: [{
            url: 'stun:stun.l.google.com:19302'
        },{
            url: 'turn:user@turn.myserver.com',
            credential: 'test'
        }]
    });

WebRTC使用ICE框架来获得这个外界可以直接访问的地址，RTCPeerConnection在创立的时候可以将ICE服务器的地址传递进去。

---
#### **5.2、提议/应答协商**
---

要在二者之间建立连接，必须在二者之间建立会话。offer/answer是一种“**一次性通过”型协商机制**。实际中该过程可能会反复多次。
WebRTC使用RTCSessionDescription对象表示提议和应答。每个浏览器都将生成一个该对象。


---
#### **5.3、JavaScript提议/应答协商控制**
---

本地浏览器只关注两个特定的调用：

    // 将我的会话描述告知我的浏览器
    pc.setLocalDescription(mySessionDescription)
    ...
    // 将对等端的会话描述告知我的浏览器
    pc.setRemoteDescription(yourSessionDescription)

生成提议、应答：

    // 生成提议
    pc.createOffer(gotOffer, didntGetOffer)
    
    function gotOffer(aSessionDescription) {
        setLocalDescription(aSessionDescription)
        ...
        // 现在可以将会话描述（提议offer）发送给对等端，以便对等端
        // a)、将提议传递给setRemoteDescription
        // b)、调用createAnswer
    }
    
    // 生成应答
    pc.createAnswer(gotAnswer, didntGetAnswer)
    
    function gotAnswer(aSessionDescription) {
        setLocalDescription(aSessionDescription)
        ...
        // 现在将会话描述（应答answer）发送给对等端，以便对等端
        // a)、将应答传递给setRemoteDescription
    }


---
### **6、NAT和防火墙穿透**
目前 P2P 通信在穿透上至少存在着两个问题:防火墙穿透和 NAT 穿透, 两者对于网络访问的限制是处于不同角度而实现的：

-	**防火墙**：是基于网络数据传输安全上的考虑，其行为主要表现为对网络协议和访问端口的限制,实际上每种限制都包含了两个方向:进和出。
-	**NAT**：则是基于网络地址转换的实现对内网主机进行的保护, 目前来说NAT的存在至少存在以下两方面的意义:
***解决 IPV4（IP协议的版本号是4，简称IPV4）地址匮乏的问题和保护网内主机。***（IPv4的地址位数为32位，也就是最多有2的32次方的电脑可以联到Internet上，IPv6采用128位地址长度，几乎可以不受限制地提供地址。）


---
#### **6.1交互式链接建立ICE**

交互式链接建立（Interactive Connectivity Establishment, ICE）是一种标准穿透协议。它利用STUN和TURN服务器帮助端点建立链接。图2显示了ICE的基本步骤：（图片来自WebRTC权威指南 第三版）9.2。

ICE基本步骤：
![7.png](https://i.loli.net/2019/03/30/5c9f183e8a0d8.png)


建立连接的前提是A、B都在线。其中传输地址是IP地址和端口号的组合。**ICE呼叫流程概览：**

- 收集候选传输地址
- 在信令通道中交换候选项
- 执行连接检查
- 选择选定的对，并启动媒体
- 发送长连接请求（KeepAlive），任何一端检测到使用中的IP地址发生变化，都重新启动ICE(即返回步骤1)。

**相关概念**

- ICE重启。因为IP地址是用来生成正在使用的候选项对的传输地址。所以无论哪一端的ICE检测到传输基地址发生改变，都会触发ICE的事件。此事件会导致改变方的ICE重新执行步骤1来收集候选项，再以SDP提议形式将这些候选项发送给另一端的ICE代理。这会使得对端的ICE也重新执行步骤1，并重复整个过程。
 
TURN和STUN协议图：
![8.png](https://i.loli.net/2019/03/30/5c9f183df1d0f.png)

---
##### **6.1.1收集候选传输地址**
---

候选地址是或许可用于接收媒体以建立对等连接的IP地址和端口。许多情况下，这些候选地址必须是在呼叫时收集的，而不能提前收集。一旦主叫A发起与B建立对等连接的请求，ICE代理A就会开始收集候选地址。一旦信令通道中收到A发来的对等连接的请求，ICE代理B就会开始收集候选地址。


表格 1 ICE候选地址类型
![9.png](https://i.loli.net/2019/03/30/5c9f183e2aa87.png)

候选地址收集完成之后，两个对等端就都拥有了自己和对方的若干候选地址，并将其配对，组成CANDIDATE PAIRS。


---
##### **6.1.2交换候选地址**

通过信令通道进行。一旦收到候选项，会先进项排序或确定优先级。一般而言：

> 主机候选地址 > 反射地址 > 中继候选项

***注意：不是双方任意组合的候选地址都可以进行通信，有的组合可能无法工作。比如offer与 answer都在NAT之后且不处于同一内网，他们就无法用自己的内网进行直接的通信。而ICE的作用就是找到所有可以进行正常通信的候选地址对，并测试***。

---
#### **6.2 防火墙**
---
防火墙充当“单向网关”，允许网络从“内部”访问“外部（INTERNET）”,但会拦截来自Internet的任意通信，防止其进入网络内部。就本质而言，防火墙的作用就是允许网络内部发起正常的IP通信，但拦截来自Internet的恶意通信。

---
### **7、数据通道**
---

RTCDataChannel，数据通道是浏览器之间建立的非媒体的交互连接。即不传递媒体消息，绕过服务器直接传递数据。相比WebSocket、http消息，数据通道支持流量大、延迟低。

**注意：** *单个对等连接中的多个数据通道底层共享一个流，所以只需一次offer、answer即可建立首个数据通道。之后再建立数据通道无需再次进行offer、answer交换。* 
**典型应用**：游戏实时状态更新。


---
#### **7.1 数据通道的使用**

只有在创建完RTCPeerConnection实例之后才能创建数据通道，一端创建完数据通道后，另一端只需要监听ondatachannel事件即可，两个对等端已经彼此建立数据通道，可以直接相互发送消息：
 


